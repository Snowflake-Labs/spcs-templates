<!DOCTYPE html>
<html lang="en">

<head>
  <title>CORS Testing</title>
  <style>
    .drop-zone {
      width: 300px;
      height: 200px;
      border: 2px dashed #aaa;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #fff;
      color: #555;
      text-align: center;
    }

    .drop-zone.dragover {
      border-color: #007bff;
      background-color: #e7f3ff;
    }

    .private-key {
      margin-top: 20px;
      white-space: pre-wrap;
      background-color: #f8f9fa;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    input[type="text"] {
      width: 80%;
    }
  </style>
</head>

<body>
  <h1>Welcome to CORS Testing Service!</h1>

  <section>
    <h2>CORS HTTP GET WITH SNOWFLAKE AUTHENTICATION</h2>
    <form>
      <label for="cors_get_input_url">Snowflake URL:</label><br>
      <input type="text" id="cors_get_input_url" name="cors_get_input_url" value="https://id-org-account.snowflakecomputing.app/healthcheck"><br>
    </form>
    <button id="authButton" onclick="initiateSnowflakeAuth()">Authenticate with Snowflake</button>
    <button id="executeRequestButton" onclick="executeCorsGetWithCookies()" style="display:none;">Execute CORS GET</button>
  </section>
  
  <h3>CORS GET Response with Cookies:</h3>
  <p id="cors_get_response_with_cookies"></p>
  <div id="status_message" style="margin-top: 10px; color: #666;"></div>

  <script>
    async function executeRequest(url, method, headers = {}, body = null, expectCustomHeader = false, withCredentials = false) {
      try {
        const options = {
          method,
          headers,
          body: body ? JSON.stringify(body) : null
        };

        if (withCredentials) {
          options.credentials = 'include';
        }

        const response = await fetch(url, options);

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        if (expectCustomHeader) {
          if (!response.headers) {
            throw new Error('Headers are empty');
          } else if (!response.headers.has('Custom-Header-X')) {
            throw new Error(`Headers do not contain Custom-Header-X, which is supposed to be exposed. Headers: ${Array.from(response.headers)}`);
          } else if (response.headers.has('Custom-Header-Y')) {
            throw new Error(`Headers contain Custom-Header-Y, which is not supposed to be exposed. Headers: ${Array.from(response.headers)}`);
          }
        }

        return await response.text();
      } catch (error) {
        console.error('Error during request:', error);
        throw error;
      }
    }

    // New functions for Snowflake authentication with redirect flow
    function initiateSnowflakeAuth() {
      const url = document.getElementById("cors_get_input_url").value;
      
      // Store the target URL for after authentication
      localStorage.setItem('snowflakeTargetUrl', url);
      
      // Store that we're in the authentication process
      localStorage.setItem('snowflakeAuthPending', 'true');
      
      // Update status
      updateStatus("Redirecting to Snowflake authentication...");
      
      // Redirect to Snowflake
      window.location.href = url;
    }

    function updateStatus(message) {
      const statusElement = document.getElementById("status_message");
      statusElement.textContent = message;
    }

    // Modified CORS request function to use stored authentication
    async function executeCorsGetWithCookies() {
      try {
        updateStatus("Executing CORS GET request with cookies...");
        
        // Get the URL we stored before auth
        const url = localStorage.getItem('snowflakeTargetUrl') || 
                    document.getElementById("cors_get_input_url").value;
        
        const headers = { 
          'Custom-Header-A': 'foo',
        };
        
        const response = await executeRequest(url, 'GET', headers, undefined, true, true);
        console.log("CORS GET response:", response);
        
        document.getElementById("cors_get_response_with_cookies").textContent = response;
        updateStatus("Request completed successfully!");
      } catch (error) {
        console.error('Error:', error);
        document.getElementById("cors_get_response_with_cookies").textContent = 
          error.toString();
        updateStatus("Request failed. See error above.");
      }
    }

    // Check authentication status on page load
    function checkAuthStatus() {
      // Check if we're returning from Snowflake auth
      if (localStorage.getItem('snowflakeAuthPending') === 'true') {
        // Clear the pending flag
        localStorage.removeItem('snowflakeAuthPending');
        
        // Show the execute button and update status
        document.getElementById("authButton").textContent = "Re-Authenticate with Snowflake";
        document.getElementById("executeRequestButton").style.display = "inline-block";
        
        updateStatus("Authentication completed! You can now execute CORS requests.");
        
        // Optionally auto-execute the request
        // executeCorsGetWithCookies();
      }
    }

    // Run on page load
    window.addEventListener('DOMContentLoaded', function() {
      checkAuthStatus();
      
      // Set the input URL from storage if available
      const storedUrl = localStorage.getItem('snowflakeTargetUrl');
      if (storedUrl) {
        document.getElementById("cors_get_input_url").value = storedUrl;
      }
    });
  </script>
</body>

</html>
